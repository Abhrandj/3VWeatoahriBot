{% extends "base.html" %}
{% block title %}Live Backtest{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">
          <i class="bi bi-lightning-charge-fill me-1"></i> Live Backtest AI Prediction
        </h3>

        <!-- Form Pilih Pair -->
        <form method="POST" class="row g-3 mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="symbol" value="{{ selected_pair }}" placeholder="e.g. BTC-USDT">
          </div>
          <div class="col-md-3">
            <select name="interval" class="form-select">
              <option value="1m" {% if request.form.interval == "1m" %}selected{% endif %}>1m</option>
              <option value="5m" {% if request.form.interval == "5m" %}selected{% endif %}>5m</option>
              <option value="15m" {% if request.form.interval == "15m" %}selected{% endif %}>15m</option>
              <option value="1H" {% if request.form.interval == "1H" %}selected{% endif %}>1H</option>
              <option value="4H" {% if request.form.interval == "4H" %}selected{% endif %}>4H</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">
              <i class="bi bi-arrow-repeat me-1"></i> Run
            </button>
          </div>
          <div class="col-md-3 d-flex align-items-center">
            <div class="form-check ms-3">
              <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
              <label class="form-check-label small" for="auto-refresh-toggle">
                Auto-refresh 60s
              </label>
            </div>
          </div>
        </form>

        <!-- Spinner Loading -->
        <div class="col-12 text-center" id="spinner-area" style="display: none;">
          <div class="spinner-border text-primary mt-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="text-muted small mt-1">Loading prediction...</div>
        </div>

        <!-- Timestamp -->
        <div class="text-end text-muted small mb-2">
          Last Updated: {{ current_time }}
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} text-center">{{ message }}</div>
          {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Grafik Prediksi -->
        <div class="card mt-4 shadow-sm">
          <div class="card-body text-center">
            <h5 class="card-title">Live Prediction Chart</h5>
            <img src="{{ url_for('static', filename='live_prediction_chart.png') }}" class="img-fluid" alt="Live Prediction Chart">
            <div class="mt-3">
              <a href="{{ url_for('static', filename='live_prediction_chart.png') }}" download class="btn btn-outline-secondary">
                <i class="bi bi-download me-1"></i> Download Chart
              </a>
            </div>
          </div>
        </div>

        <!-- Tabel Data -->
        {% if result %}
        <div class="table-responsive mt-4">
          <table class="table table-striped table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Volume</th>
              </tr>
            </thead>
            <tbody>
              {% for row in result %}
              <tr>
                <td>{{ row.datetime }}</td>
                <td>{{ row.open }}</td>
                <td>{{ row.high }}</td>
                <td>{{ row.low }}</td>
                <td>{{ row.close }}</td>
                <td>{{ row.volume }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-warning text-center mt-3">
          Data tidak tersedia atau gagal memuat data OHLCV.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}